name: Nightly Charger Check (8 PM PST)

on:
  workflow_dispatch: # Manual trigger for testing

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-chargepoint
    
    - name: Check charger and notify if offline
      env:
        CP_USERNAME: ${{ secrets.CP_USERNAME }}
        CP_PASSWORD: ${{ secrets.CP_PASSWORD }}
      run: |
        python3 << 'EOF'
        import os
        from datetime import datetime
        from zoneinfo import ZoneInfo
        from python_chargepoint import ChargePoint

        print("=" * 60)
        print("Nightly Charger Status Check (8 PM PST)")
        print(f"UTC Time: {datetime.now(ZoneInfo('UTC')).strftime('%Y-%m-%d %H:%M:%S %Z')}")
        print(f"PST Time: {datetime.now(ZoneInfo('America/Los_Angeles')).strftime('%Y-%m-%d %H:%M:%S %Z')}")
        print("=" * 60)

        # Check if it's actually 8 PM PST
        pacific = ZoneInfo("America/Los_Angeles")
        now = datetime.now(pacific)
        if now.hour != 20:
            print(f"\nâ„¹ï¸  Not 8 PM PST (current hour: {now.hour})")
            print("Exiting without notification")
            exit(0)

        print("\nðŸ•— It's 8 PM PST - checking charger status...")

        username = os.environ.get("CP_USERNAME")
        password = os.environ.get("CP_PASSWORD")

        try:
            print(f"ðŸ” Authenticating as {username}...")
            client = ChargePoint(username=username, password=password)
            print("âœ“ Authentication successful\n")
            
            print("ðŸ” Fetching charger status...")
            chargers = client.get_home_chargers()
            
            if not chargers:
                print("âŒ No chargers found")
                exit(1)
            
            charger_id = chargers[0]
            status = client.get_home_charger_status(charger_id)
            
            print(f"ðŸ“Š Charger {charger_id}:")
            print(f"   Connected: {status.connected}")
            print(f"   Plugged In: {status.plugged_in}")
            print(f"   Last Connected: {status.last_connected_at}")
            
            if status.connected:
                print("\nâœ… Charger is ONLINE - no notification needed")
                exit(0)
            
            print("\nâŒ Charger is OFFLINE - failing run to trigger GitHub notification")
            exit(1)
            
            # Optional: Send email notification
            if alert_email:
                print(f"â„¹ï¸  Alert email configured for {alert_email}")
            
            print("\n" + "=" * 60)
            print("âœ… Notification process completed")
            print("=" * 60)
            
        except Exception as e:
            print(f"\nâŒ ERROR: {type(e).__name__}: {str(e)}")
            exit(1)
        EOF
