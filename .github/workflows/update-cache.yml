name: Update Session Cache

on:
  # Weekly on Sunday at midnight Pacific (8am UTC)
  schedule:
    - cron: '0 8 * * 0'  # Current month update (weekly)
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      mode:
        description: 'Cache update mode'
        required: true
        default: 'current'
        type: choice
        options:
          - current    # Current month to now
          - last       # Last month (full)
          - month      # Specific month (requires month parameter)
      month:
        description: 'Specific month (YYYY-MM, only used if mode=month)'
        required: false
        type: string

jobs:
  update-cache:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: Update current month cache (scheduled)
        if: github.event_name == 'schedule'
        env:
          CP_USERNAME: ${{ secrets.CP_USERNAME }}
          CP_PASSWORD: ${{ secrets.CP_PASSWORD }}
        run: |
          echo "ðŸ“… Updating current month cache (scheduled weekly run)"
          python fetch_session_details.py --current
      
      - name: Update current month cache (manual)
        if: github.event_name == 'workflow_dispatch' && inputs.mode == 'current'
        env:
          CP_USERNAME: ${{ secrets.CP_USERNAME }}
          CP_PASSWORD: ${{ secrets.CP_PASSWORD }}
        run: |
          echo "ðŸ“… Updating current month cache"
          python fetch_session_details.py --current
      
      - name: Update last month cache
        if: github.event_name == 'workflow_dispatch' && inputs.mode == 'last'
        env:
          CP_USERNAME: ${{ secrets.CP_USERNAME }}
          CP_PASSWORD: ${{ secrets.CP_PASSWORD }}
        run: |
          LAST_MONTH=$(date -d "last month" +%Y-%m)
          echo "ðŸ“… Updating cache for $LAST_MONTH"
          python fetch_session_details.py --month $LAST_MONTH
      
      - name: Update specific month cache
        if: github.event_name == 'workflow_dispatch' && inputs.mode == 'month'
        env:
          CP_USERNAME: ${{ secrets.CP_USERNAME }}
          CP_PASSWORD: ${{ secrets.CP_PASSWORD }}
        run: |
          echo "ðŸ“… Updating cache for ${{ inputs.month }}"
          python fetch_session_details.py --month ${{ inputs.month }}
      
      - name: Push changes
        run: |
          git push
